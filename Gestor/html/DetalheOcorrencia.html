<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Detalhe da OcorrÃªncia - EyesEverywhere</title>
  <link rel="stylesheet" href="/Back-Office/Gestor/css/DetalheOcorrencia.css" />
  <link rel="icon" href="/Back-Office/Gestor/Imagens/logo.png" type="image/x-icon" />
</head>
<body>
  <div class="sidebar">
    <div class="logo">
      <img src="/Back-Office/Gestor/Imagens/logo.png" alt="EyesEverywhere" />
    </div>
    <nav>
      <ul>
        <li><a data-page="Ocorrencias.html" href="Ocorrencias.html">ğŸ“‹ OcorrÃªncias</a></li>
        <li><a class="active" data-page="NovasOcorrencias.html" href="NovasOcorrencias.html">â• Novas OcorrÃªncias</a></li>
        <li><a data-page="Peritos.html" href="Peritos.html">ğŸ‘¥ Peritos</a></li>
        <li><a data-page="Registar_Peritos.html" href="Registar_Peritos.html">ğŸ“ Registar Peritos</a></li>
        <li><a data-page="Geral.html" href="Geral.html">ğŸ” EstatÃ­sticas</a></li>
      </ul>
    </nav>
    <div class="add-auditoria"> 
      <a href="/Back-Office/Gestor/html/PlanoAuditoria.html">
        <button>+ Adicionar Plano de Auditoria</button>
      </a>
    </div>
    <div class="user-info">
      <p id="user-name">Utilizador nÃ£o logado</p>
      <p id="user-email">Sem e-mail</p>
    </div>
  </div>

  <div class="content">
    <header>
      <h1>Detalhe da OcorrÃªncia</h1>
    </header>

    <section class="ocorrencia-detalhada">
      <div class="ocorrencia-info">
        <h3>InformaÃ§Ãµes da OcorrÃªncia</h3>
        <p><strong>Tipo:</strong> <span id="tipo-ocorrencia"></span></p>
        <p><strong>Morada:</strong> <span id="morada-ocorrencia"></span></p>
        <p><strong>Cidade:</strong> <span id="cidade-ocorrencia"></span></p>
        <p><strong>CÃ³digo Postal:</strong> <span id="codigo-postal-ocorrencia"></span></p>
        <p><strong>Data:</strong> <span id="data-ocorrencia"></span></p>
        <p><strong>Hora:</strong> <span id="hora-ocorrencia"></span></p>
        <p><strong>InformaÃ§Ãµes Extras:</strong> <span id="informacoes-ocorrencia"></span></p>
      </div>

      <div class="user-info">
        <h3>InformaÃ§Ãµes do Utilizador</h3>
        <p><strong>Nome:</strong> <span id="user-name-ocorrencia"></span></p>
        <p><strong>Email:</strong> <span id="user-email-ocorrencia"></span></p>
        <p><strong>Telefone:</strong> <span id="user-telefone-ocorrencia"></span></p>
      </div>

      <div class="acao">
        <h3>Estado da OcorrÃªncia</h3>
        <button id="aceitar-btn" class="btn btn-success">Aceitar</button>
        <button id="rejeitar-btn" class="btn btn-danger">Rejeitar</button>
        <button id="mais-informacao-btn" class="btn btn-warning">Enviar para mais informaÃ§Ã£o</button>
      </div>

      <!-- Novo espaÃ§o para inserir detalhes adicionais -->
      <div id="detalhes-adicionais" style="display:none;">
        <label for="detalhes-texto">Detalhes adicionais:</label>
        <textarea id="detalhes-texto" class="form-control" placeholder="Escreva aqui os detalhes adicionais que precisa"></textarea>
        <button id="confirmar-detalhes" class="btn btn-primary">Confirmar</button>
      </div>
    </section>
  </div>

  <!-- Ãrea para exibir mensagens de feedback -->
  <div id="feedback-message" class="feedback-message"></div>

  <script>
    // FunÃ§Ã£o para atualizar as informaÃ§Ãµes do utilizador
    function atualizarUtilizador() {
      const nome = localStorage.getItem("userName") || "Utilizador nÃ£o logado";
      const email = localStorage.getItem("userEmail") || "Sem e-mail";
      
      // Preenche as informaÃ§Ãµes do utilizador na sidebar
      document.getElementById("user-name").innerText = nome;
      document.getElementById("user-email").innerText = email;
    }

    // FunÃ§Ã£o para carregar os dados da ocorrÃªncia e do utilizador
    function carregarDetalhes() {
      const ocorrencias = JSON.parse(localStorage.getItem("ocorrencias")) || [];
      const ocorrenciaID = localStorage.getItem("ocorrenciaID");

      // Procura pela ocorrÃªncia que corresponde ao ID
      const ocorrencia = ocorrencias.find(ocorrencia => ocorrencia.id == ocorrenciaID);

      if (ocorrencia) {
        document.getElementById("tipo-ocorrencia").innerText = ocorrencia.tipo;
        document.getElementById("morada-ocorrencia").innerText = ocorrencia.morada;
        document.getElementById("cidade-ocorrencia").innerText = ocorrencia.cidade;
        document.getElementById("codigo-postal-ocorrencia").innerText = ocorrencia.codigoPostal || 'NÃ£o especificado';
        document.getElementById("data-ocorrencia").innerText = ocorrencia.data;
        document.getElementById("hora-ocorrencia").innerText = ocorrencia.hora;
        document.getElementById("informacoes-ocorrencia").innerText = ocorrencia.informacoes;

        const userName = localStorage.getItem("userName");
        const userEmail = localStorage.getItem("userEmail");
        const userTelefone = localStorage.getItem("userTelefone");

        document.getElementById("user-name-ocorrencia").innerText = userName || "Desconhecido";
        document.getElementById("user-email-ocorrencia").innerText = userEmail || "NÃ£o disponÃ­vel";
        document.getElementById("user-telefone-ocorrencia").innerText = userTelefone || "NÃ£o disponÃ­vel";
      } else {
        alert("OcorrÃªncia nÃ£o encontrada.");
      }
    }

    // FunÃ§Ã£o para exibir a mensagem personalizada no topo
    function showFeedbackMessage(message, type = 'success') {
      const feedbackMessage = document.getElementById('feedback-message');

      // Limpa qualquer mensagem anterior
      feedbackMessage.innerHTML = message;

      // Adiciona a classe de tipo (success, error, warning)
      feedbackMessage.classList.remove('success', 'error', 'warning');
      feedbackMessage.classList.add(type);

      // Exibe a mensagem
      feedbackMessage.style.display = 'block';

      // Oculta a mensagem apÃ³s 3 segundos
      setTimeout(() => {
        feedbackMessage.style.display = 'none';
      }, 3000);
    }

    // Exemplo de uso:
    // Ao clicar no botÃ£o de Aceitar
    document.getElementById("aceitar-btn").addEventListener("click", function() {
      setTimeout(function() {
        // Redireciona para a pÃ¡gina de adicionar plano de auditoria
        window.location.href = "/Back-Office/Gestor/html/PlanoAuditoria.html"; 
      }, 2000); // O redirecionamento ocorre apÃ³s 2 segundos
    });

    // Ao clicar no botÃ£o de Rejeitar
    document.getElementById("rejeitar-btn").addEventListener("click", function() {
      const ocorrenciaID = localStorage.getItem("ocorrenciaID");
      removerOcorrencia(Number(ocorrenciaID)); // Remove a ocorrÃªncia do localStorage
      showFeedbackMessage("OcorrÃªncia Rejeitada!", "error");
      setTimeout(function() {
        window.location.href = "NovasOcorrencias.html"; // Redireciona para a pÃ¡gina de novas ocorrÃªncias
      }, 2000); // O redirecionamento ocorre apÃ³s 2 segundos  
    });

    // Exibir o campo de detalhes adicionais ao clicar no botÃ£o "Enviar para mais informaÃ§Ã£o"
    document.getElementById("mais-informacao-btn").addEventListener("click", function() {
      document.getElementById("detalhes-adicionais").style.display = "block";
    });

    // Confirmar os detalhes e atualizar o estado da ocorrÃªncia
    document.getElementById("confirmar-detalhes").addEventListener("click", function() {
      const detalhesTexto = document.getElementById("detalhes-texto").value.trim();

      // Verifica se o campo de detalhes nÃ£o estÃ¡ vazio
      if (detalhesTexto === "") {
        showFeedbackMessage("Por favor, insira mais informaÃ§Ãµes.", "warning");
        return;
      }

      const ocorrencias = JSON.parse(localStorage.getItem("ocorrencias")) || [];
      const ocorrenciaID = localStorage.getItem("ocorrenciaID");

      // Procura pela ocorrÃªncia e altera o estado para "Pendente"
      const ocorrencia = ocorrencias.find(ocorrencia => ocorrencia.id == ocorrenciaID);
      if (ocorrencia) {
        ocorrencia.estado = "Pendente"; // Altera o estado da ocorrÃªncia para "Pendente"
        ocorrencia.detalhesAdicionais = detalhesTexto; // Salva os detalhes adicionais
        localStorage.setItem("ocorrencias", JSON.stringify(ocorrencias)); // Atualiza o localStorage
        showFeedbackMessage("OcorrÃªncia enviada para mais informaÃ§Ãµes.", "warning");
        setTimeout(function() {
          window.location.href = "NovasOcorrencias.html"; // Redireciona para a pÃ¡gina de Novas OcorrÃªncias
        }, 2000); // O redirecionamento ocorre apÃ³s 2 segundos
      }
    });

    // Marcar a pÃ¡gina de "Novas OcorrÃªncias" como ativa na sidebar
    const menuItems = document.querySelectorAll("nav ul li a");
    menuItems.forEach(item => {
      if (item.getAttribute("href") === "NovasOcorrencias.html") {
        item.classList.add("active");
      }
    });

    // Carregar detalhes ao iniciar a pÃ¡gina
    document.addEventListener("DOMContentLoaded", function() {
      atualizarUtilizador();
      carregarDetalhes();
    });
  </script>

</body>
</html>
