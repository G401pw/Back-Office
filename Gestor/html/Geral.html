<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EstatÃ­sticas - EyesEverywhere</title>
  <link rel="stylesheet" href="/Back-Office/Gestor/css/Geral.css" />
  <link rel="icon" href="/Back-Office/Gestor/Imagens/logo.png" />
  <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div id="app">
    <div class="sidebar">
      <div class="logo">
        <img src="/Back-Office/Gestor/Imagens/logo.png" alt="EyesEverywhere" />
      </div>
      <nav>
        <ul>
          <li><a data-page="Ocorrencias.html" href="Ocorrencias.html">ğŸ“‹ OcorrÃªncias</a></li>
          <li><a data-page="NovasOcorrencias.html" href="NovasOcorrencias.html">â• Novas OcorrÃªncias</a></li>
          <li><a data-page="Peritos.html" href="Peritos.html">ğŸ‘¥ Peritos</a></li>
          <li><a data-page="Registar_Peritos.html" href="Registar_Peritos.html">ğŸ“ Registar Peritos</a></li>
          <li><a class="active" data-page="Geral.html" href="Geral.html">ğŸ” EstatÃ­sticas</a></li>
        </ul>
      </nav>
      <div class="add-auditoria">
        <a href="/Back-Office/Gestor/html/PlanoAuditoria.html">
          <button>+ Adicionar Plano de Auditoria</button>
        </a>
      </div>
      <div class="user-info">
        <p>{{ userName }}</p>
        <p>{{ userEmail }}</p>
      </div>
    </div>

    <div class="content">
      <header>
        <h1>EstatÃ­sticas</h1>
      </header>

      <main>
        <section class="stats-summary">
          <div class="stat-box visitas">
            <h3>Visitas ao Site Hoje</h3>
            <p>{{ visitasHoje }}</p>
          </div>
          <div class="stat-box peritos">
            <h3>Peritos DisponÃ­veis</h3>
            <p>{{ peritosDisponiveis }}</p>
          </div>
          <div class="stat-box ocorrencias">
            <h3>OcorrÃªncias em AÃ§Ã£o</h3>
            <p>{{ ocorrenciasEmAcao }}</p>
          </div>
        </section>

        <section class="charts">
          <div class="chart-box">
            <h3>Especialidades dos Peritos</h3>
            <canvas id="especialidadesChart"></canvas>
          </div>
          <div class="chart-box">
            <h3>OcorrÃªncias Resolvidas por MÃªs</h3>
            <canvas id="numOcorrencias"></canvas>
          </div>
        </section>
      </main>
    </div>
  </div>

  <script>
    new Vue({
      el: '#app',
      data: {
        visitasHoje: 0,
        peritos: JSON.parse(localStorage.getItem("peritos")) || [],
        auditorias: JSON.parse(localStorage.getItem("auditorias")) || [],
        userName: localStorage.getItem("userName") || "Utilizador nÃ£o logado",
        userEmail: localStorage.getItem("userEmail") || "Sem e-mail"
      },
      computed: {
        peritosDisponiveis() {
          return this.peritos.filter(perito => perito.estado === "desocupado").length;
        },
        ocorrenciasEmAcao() {
          return this.auditorias.filter(a => a.estado === "em-progresso").length;
        },
        especialidades() {
          const contador = {};
          this.peritos.forEach(perito => {
            if (contador[perito.especialidade]) {
              contador[perito.especialidade]++;
            } else {
              contador[perito.especialidade] = 1;
            }
          });
          return contador;
        }
      },
      mounted() {
        this.renderCharts();
        this.atualizarContadorVisitas();
      },
      methods: {
        renderCharts() {
          this.renderEspecialidadesChart();
          this.renderOcorrenciasChart();
        },

        renderEspecialidadesChart() {
          const especialidadesData = this.especialidades;
          const labels = Object.keys(especialidadesData);
          const data = Object.values(especialidadesData);

          const ctx = document.getElementById('especialidadesChart').getContext('2d');
          new Chart(ctx, {
            type: 'pie',
            data: {
              labels: labels,
              datasets: [{
                data: data,
                backgroundColor: [
                  '#00C49F', '#FFBB28', '#0088FE', '#FF8042',
                  '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                  '#9966FF', '#FF9F40', '#C9CBCF', '#7E57C2',
                  '#26A69A', '#D4E157'
                ]
              }]
            }
          });
        },

        renderOcorrenciasChart() {
          const ctx = document.getElementById('numOcorrencias').getContext('2d');

          // Inicializar um array com 12 posiÃ§Ãµes a 0 (para cada mÃªs)
          const dadosPorMes = Array(12).fill(0);

          // Obter auditorias do localStorage
          const auditorias = JSON.parse(localStorage.getItem("auditorias")) || [];

          // Contar quantas auditorias estÃ£o concluÃ­das por mÃªs
          auditorias.forEach(auditoria => {
            if (auditoria.estado === "concluido" && auditoria.data) {
              const mes = new Date(auditoria.data).getMonth(); // 0 (jan) a 11 (dez)
              dadosPorMes[mes]++;
            }
          });

          // Criar grÃ¡fico
          new Chart(ctx, {
            type: 'bar',
            data: {
              labels: ['JAN', 'FEB', 'MAR', 'ABR', 'MAI', 'JUN', 'JUL', 'AGO', 'SET', 'OUT', 'NOV', 'DEZ'],
              datasets: [{
                label: 'OcorrÃªncias Resolvidas',
                data: dadosPorMes,
                backgroundColor: '#0088FE'
              }]
            }
          });
        },
        
      }
    });
  </script>
</body>
</html>
